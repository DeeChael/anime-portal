import s from"node:process";import{Buffer as O}from"node:buffer";import $ from"node:path";import{fileURLToPath as W}from"node:url";import{promisify as g}from"node:util";import H,{execFile as h}from"node:child_process";import b,{constants as I}from"node:fs/promises";import U from"node:os";import v from"node:fs";let y;function D(){try{return v.statSync("/.dockerenv"),!0}catch{return!1}}function R(){try{return v.readFileSync("/proc/self/cgroup","utf8").includes("docker")}catch{return!1}}function N(){return y===void 0&&(y=D()||R()),y}let S;const z=()=>{try{return v.statSync("/run/.containerenv"),!0}catch{return!1}};function P(){return S===void 0&&(S=z()||N()),S}const A=()=>{if(s.platform!=="linux")return!1;if(U.release().toLowerCase().includes("microsoft"))return!P();try{return v.readFileSync("/proc/version","utf8").toLowerCase().includes("microsoft")?!P():!1}catch{return!1}},p=s.env.__IS_WSL_TEST__?A:A(),G=(()=>{const e="/mnt/";let r;return async function(){if(r)return r;const o="/etc/wsl.conf";let n=!1;try{await b.access(o,I.F_OK),n=!0}catch{}if(!n)return e;const t=await b.readFile(o,{encoding:"utf8"}),a=new RegExp("(?<!#.*)root\\s*=\\s*(?<mountPoint>.*)","g").exec(t);return a?(r=a.groups.mountPoint.trim(),r=r.endsWith("/")?r:`${r}/`,r):e}})(),X=async()=>`${await G()}c/Windows/System32/WindowsPowerShell/v1.0/powershell.exe`,_=async()=>p?X():`${s.env.SYSTEMROOT||s.env.windir||String.raw`C:\Windows`}\\System32\\WindowsPowerShell\\v1.0\\powershell.exe`;function d(e,r,o){const n=t=>Object.defineProperty(e,r,{value:t,enumerable:!0,writable:!0});return Object.defineProperty(e,r,{configurable:!0,enumerable:!0,get(){const t=o();return n(t),t},set(t){n(t)}}),e}const K=g(h);async function V(){if(s.platform!=="darwin")throw new Error("macOS only");const{stdout:e}=await K("defaults",["read","com.apple.LaunchServices/com.apple.launchservices.secure","LSHandlers"]),o=/LSHandlerRoleAll = "(?!-)(?<id>[^"]+?)";\s+?LSHandlerURLScheme = (?:http|https);/.exec(e)?.groups.id??"com.apple.Safari";return o==="com.apple.safari"?"com.apple.Safari":o}const j=g(h);async function q(e,{humanReadableOutput:r=!0,signal:o}={}){if(s.platform!=="darwin")throw new Error("macOS only");const n=r?[]:["-ss"],t={};o&&(t.signal=o);const{stdout:a}=await j("osascript",["-e",e,n],t);return a.trim()}async function Y(e){return q(`tell application "Finder" to set app_path to application file id "${e}" as string
tell application "System Events" to get value of property list item "CFBundleName" of property list file (app_path & ":Contents:Info.plist")`)}const J=g(h),k={MSEdgeHTM:{name:"Edge",id:"com.microsoft.edge"},MSEdgeBHTML:{name:"Edge Beta",id:"com.microsoft.edge.beta"},MSEdgeDHTML:{name:"Edge Dev",id:"com.microsoft.edge.dev"},AppXq0fevzme2pys62n3e0fbqa7peapykr8v:{name:"Edge",id:"com.microsoft.edge.old"},ChromeHTML:{name:"Chrome",id:"com.google.chrome"},ChromeBHTML:{name:"Chrome Beta",id:"com.google.chrome.beta"},ChromeDHTML:{name:"Chrome Dev",id:"com.google.chrome.dev"},ChromiumHTM:{name:"Chromium",id:"org.chromium.Chromium"},BraveHTML:{name:"Brave",id:"com.brave.Browser"},BraveBHTML:{name:"Brave Beta",id:"com.brave.Browser.beta"},BraveDHTML:{name:"Brave Dev",id:"com.brave.Browser.dev"},BraveSSHTM:{name:"Brave Nightly",id:"com.brave.Browser.nightly"},FirefoxURL:{name:"Firefox",id:"org.mozilla.firefox"},OperaStable:{name:"Opera",id:"com.operasoftware.Opera"},VivaldiHTM:{name:"Vivaldi",id:"com.vivaldi.Vivaldi"},"IE.HTTP":{name:"Internet Explorer",id:"com.microsoft.ie"}};new Map(Object.entries(k));class C extends Error{}async function Q(e=J){const{stdout:r}=await e("reg",["QUERY"," HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\Shell\\Associations\\UrlAssociations\\http\\UserChoice","/v","ProgId"]),o=/ProgId\s*REG_SZ\s*(?<id>\S+)/.exec(r);if(!o)throw new C(`Cannot find Windows browser in stdout: ${JSON.stringify(r)}`);const{id:n}=o.groups,t=k[n];if(!t)throw new C(`Unknown browser ID: ${n}`);return t}const Z=g(h),ee=e=>e.toLowerCase().replaceAll(/(?:^|\s|-)\S/g,r=>r.toUpperCase());async function re(){if(s.platform==="darwin"){const e=await V();return{name:await Y(e),id:e}}if(s.platform==="linux"){const{stdout:e}=await Z("xdg-mime",["query","default","x-scheme-handler/http"]),r=e.trim();return{name:ee(r.replace(/.desktop$/,"").replace("-"," ")),id:r}}if(s.platform==="win32")return Q();throw new Error("Only macOS, Linux, and Windows are supported")}const oe=g(H.execFile),E=$.dirname(W(import.meta.url)),F=$.join(E,"xdg-open"),{platform:f,arch:M}=s;async function te(){const e=await _(),r=String.raw`(Get-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\Shell\Associations\UrlAssociations\http\UserChoice").ProgId`,o=O.from(r,"utf16le").toString("base64"),{stdout:n}=await oe(e,["-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand",o],{encoding:"utf8"}),t=n.trim(),a={ChromeHTML:"com.google.chrome",BraveHTML:"com.brave.Browser",MSEdgeHTM:"com.microsoft.edge",FirefoxURL:"org.mozilla.firefox"};return a[t]?{id:a[t]}:{}}const T=async(e,r)=>{let o;for(const n of e)try{return await r(n)}catch(t){o=t}throw o},w=async e=>{if(e={wait:!1,background:!1,newInstance:!1,allowNonzeroExitCode:!1,...e},Array.isArray(e.app))return T(e.app,i=>w({...e,app:i}));let{name:r,arguments:o=[]}=e.app??{};if(o=[...o],Array.isArray(r))return T(r,i=>w({...e,app:{name:i,arguments:o}}));if(r==="browser"||r==="browserPrivate"){const i={"com.google.chrome":"chrome","google-chrome.desktop":"chrome","com.brave.Browser":"brave","org.mozilla.firefox":"firefox","firefox.desktop":"firefox","com.microsoft.msedge":"edge","com.microsoft.edge":"edge","com.microsoft.edgemac":"edge","microsoft-edge.desktop":"edge"},c={chrome:"--incognito",brave:"--incognito",firefox:"--private-window",edge:"--inPrivate"},m=p?await te():await re();if(m.id in i){const B=i[m.id];return r==="browserPrivate"&&o.push(c[B]),w({...e,app:{name:l[B],arguments:o}})}throw new Error(`${m.name} is not supported as a default browser`)}let n;const t=[],a={};if(f==="darwin")n="open",e.wait&&t.push("--wait-apps"),e.background&&t.push("--background"),e.newInstance&&t.push("--new"),r&&t.push("-a",r);else if(f==="win32"||p&&!P()&&!r){n=await _(),t.push("-NoProfile","-NonInteractive","-ExecutionPolicy","Bypass","-EncodedCommand"),p||(a.windowsVerbatimArguments=!0);const i=["Start"];e.wait&&i.push("-Wait"),r?(i.push(`"\`"${r}\`""`),e.target&&o.push(e.target)):e.target&&i.push(`"${e.target}"`),o.length>0&&(o=o.map(c=>`"\`"${c}\`""`),i.push("-ArgumentList",o.join(","))),e.target=O.from(i.join(" "),"utf16le").toString("base64")}else{if(r)n=r;else{const i=!E||E==="/";let c=!1;try{await b.access(F,I.X_OK),c=!0}catch{}n=s.versions.electron??(f==="android"||i||!c)?"xdg-open":F}o.length>0&&t.push(...o),e.wait||(a.stdio="ignore",a.detached=!0)}f==="darwin"&&o.length>0&&t.push("--args",...o),e.target&&t.push(e.target);const u=H.spawn(n,t,a);return e.wait?new Promise((i,c)=>{u.once("error",c),u.once("close",m=>{if(!e.allowNonzeroExitCode&&m>0){c(new Error(`Exited with code ${m}`));return}i(u)})}):(u.unref(),u)},ue=(e,r)=>{if(typeof e!="string")throw new TypeError("Expected a `target`");return w({...r,target:e})},pe=(e,r)=>{if(typeof e!="string"&&!Array.isArray(e))throw new TypeError("Expected a valid `name`");const{arguments:o=[]}=r??{};if(o!=null&&!Array.isArray(o))throw new TypeError("Expected `appArguments` as Array type");return w({...r,app:{name:e,arguments:o}})};function L(e){if(typeof e=="string"||Array.isArray(e))return e;const{[M]:r}=e;if(!r)throw new Error(`${M} is not supported`);return r}function x({[f]:e},{wsl:r}){if(r&&p)return L(r);if(!e)throw new Error(`${f} is not supported`);return L(e)}const l={};d(l,"chrome",()=>x({darwin:"google chrome",win32:"chrome",linux:["google-chrome","google-chrome-stable","chromium"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe",x64:["/mnt/c/Program Files/Google/Chrome/Application/chrome.exe","/mnt/c/Program Files (x86)/Google/Chrome/Application/chrome.exe"]}}));d(l,"brave",()=>x({darwin:"brave browser",win32:"brave",linux:["brave-browser","brave"]},{wsl:{ia32:"/mnt/c/Program Files (x86)/BraveSoftware/Brave-Browser/Application/brave.exe",x64:["/mnt/c/Program Files/BraveSoftware/Brave-Browser/Application/brave.exe","/mnt/c/Program Files (x86)/BraveSoftware/Brave-Browser/Application/brave.exe"]}}));d(l,"firefox",()=>x({darwin:"firefox",win32:String.raw`C:\Program Files\Mozilla Firefox\firefox.exe`,linux:"firefox"},{wsl:"/mnt/c/Program Files/Mozilla Firefox/firefox.exe"}));d(l,"edge",()=>x({darwin:"microsoft edge",win32:"msedge",linux:["microsoft-edge","microsoft-edge-dev"]},{wsl:"/mnt/c/Program Files (x86)/Microsoft/Edge/Application/msedge.exe"}));d(l,"browser",()=>"browser");d(l,"browserPrivate",()=>"browserPrivate");export{l as apps,ue as default,pe as openApp};
